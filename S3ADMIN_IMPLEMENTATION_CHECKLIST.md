# ğŸš€ S3Admin é›†æˆå®Œæˆæ£€æŸ¥æ¸…å•

## å·²å®Œæˆçš„å®ç°

### âœ… 1. åˆ›å»º Supabase å®¢æˆ·ç«¯æ–‡ä»¶
- **ä½ç½®**ï¼š[src/lib/supabaseClient.ts](src/lib/supabaseClient.ts)
- **åŠŸèƒ½**ï¼š
  - åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
  - å¯¼å‡º `getAccessToken()` å‡½æ•°ç”¨äºè·å–å½“å‰ç”¨æˆ·çš„ access_token

### âœ… 2. æ›´æ–° S3Admin ç»„ä»¶
- **ä½ç½®**ï¼š[components/S3Admin.tsx](components/S3Admin.tsx)
- **æ›´æ”¹**ï¼š
  - æ–°å¢ Propsï¼š`adminPassword`ã€`edgeBaseUrl`ã€`defaultBucket`
  - æ”¹è¿›çš„ `authFetch()` å‡½æ•°ï¼Œæ·»åŠ  `x-admin-password` header
  - å½“ `adminPassword` ä¸ºç©ºæ—¶æ˜¾ç¤ºå‹å¥½æç¤º
  - ä½¿ç”¨ `getAccessToken()` è·å–ç”¨æˆ· token
  - å®Œæ•´çš„ Listã€Getã€Putã€Delete æ“ä½œå®ç°

### âœ… 3. æ›´æ–° AdminPage ç»„ä»¶
- **ä½ç½®**ï¼š[pages/AdminPage.tsx](pages/AdminPage.tsx)
- **æ›´æ”¹**ï¼š
  - æ–°å¢ `adminPassword` state
  - `handleAdminLogin()` ç°åœ¨ä¿å­˜å¯†ç åˆ° state
  - å‘ S3Admin ä¼ å…¥ `adminPassword` prop

### âœ… 4. æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®
- **ä½ç½®**ï¼š[.env.local](.env.local)
- **æ–°å¢**ï¼š`VITE_FUNCTIONS_URL`ï¼ˆEdge Function å®Œæ•´ URLï¼‰
- **ä½ç½®**ï¼š[.env.example](.env.example)
- **æ›´æ–°**ï¼šæ·»åŠ  VITE_FUNCTIONS_URL çš„è¯´æ˜å’Œç¤ºä¾‹

### âœ… 5. åˆ›å»ºå®Œæ•´é›†æˆæŒ‡å—
- **ä½ç½®**ï¼š[S3ADMIN_INTEGRATION_GUIDE.md](S3ADMIN_INTEGRATION_GUIDE.md)
- **å†…å®¹**ï¼š
  - å®Œæ•´çš„å·¥ä½œæµç¨‹è¯´æ˜
  - API ç«¯ç‚¹æ–‡æ¡£
  - curl æµ‹è¯•ç¤ºä¾‹
  - å®‰å…¨å»ºè®®
  - å¸¸è§é—®é¢˜è§£ç­”

---

## ğŸ“‹ ä½¿ç”¨æµç¨‹

```
ç”¨æˆ·ç™»å½• (Auth)
    â†“
è®¿é—® /admin
    â†“
è¾“å…¥ç®¡ç†å‘˜å¯†ç  (AdminLoginModal)
    â†“
AdminPage ä¿å­˜å¯†ç åˆ° state
    â†“
ç‚¹å‡» "S3 Admin" æ ‡ç­¾
    â†“
S3Admin ç»„ä»¶æ¿€æ´»
    â†“
getAccessToken() è·å–ç”¨æˆ· token
    â†“
authFetch() ä½¿ç”¨ token + password å‘é€è¯·æ±‚åˆ° Edge Function
    â†“
Edge Function éªŒè¯ token å’Œ password
    â†“
æ‰§è¡Œ S3 æ“ä½œ (list/get/put/delete)
```

---

## ğŸ”’ å®‰å…¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ (React)                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AdminLoginModal â† æ”¶é›†ç®¡ç†å‘˜å¯†ç                                 â”‚
â”‚ AdminPage       â† ä¿å­˜åˆ°å†…å­˜çŠ¶æ€ï¼ˆä¸æŒä¹…åŒ–ï¼‰                    â”‚
â”‚ S3Admin         â† ä½¿ç”¨å¯†ç æ„å»ºè¯·æ±‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ HTTPS
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ è¯·æ±‚ Headers:        â”‚
              â”‚ - Authorization:     â”‚
              â”‚   Bearer <token>     â”‚
              â”‚ - x-admin-password:  â”‚
              â”‚   <password>         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function (supabase.co/s3-compat-storage)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å– Authorization header                                    â”‚
â”‚ 2. ä½¿ç”¨ Supabase Auth éªŒè¯ token â†’ ç¡®è®¤ç”¨æˆ·èº«ä»½                 â”‚
â”‚ 3. è¯»å– x-admin-password header                                 â”‚
â”‚ 4. å¯¹æ¯”ç¯å¢ƒå˜é‡ä¸­çš„ ADMIN_PASSWORD                              â”‚
â”‚ 5. éƒ½é€šè¿‡ â†’ æ‰§è¡Œ S3 æ“ä½œ                                         â”‚
â”‚ 6. è¿”å›ç»“æœç»™å‰ç«¯                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ ç¯å¢ƒå˜é‡æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²å‰ï¼Œç¡®ä¿è¿™äº›å˜é‡å·²æ­£ç¡®è®¾ç½®ï¼š

### å‰ç«¯ç¯å¢ƒå˜é‡ (.env.local)
- [ ] `VITE_SUPABASE_AUTH_URL` - ä½ çš„ Supabase é¡¹ç›® URL
- [ ] `VITE_SUPABASE_ANON_KEY` - Supabase åŒ¿å Key
- [ ] `VITE_SUPABASE_S3_BUCKET` - S3 å­˜å‚¨æ¡¶åç§°ï¼ˆé»˜è®¤: wangyiyunï¼‰
- [ ] `VITE_FUNCTIONS_URL` - Edge Function å®Œæ•´ URL

### Edge Function ç¯å¢ƒå˜é‡ (Supabase æ§åˆ¶å°)
- [ ] `ADMIN_PASSWORD` - ç®¡ç†å‘˜å¯†ç ï¼ˆåº”è¯¥ä¸ AdminLoginModal ä¸­éªŒè¯çš„å¯†ç ä¸€è‡´ï¼‰

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æœ¬åœ°æµ‹è¯•
```bash
cd /path/to/lovewwy
npm run dev
# è®¿é—® http://localhost:5173/admin
```

### 2. åŠŸèƒ½æµ‹è¯•
- [ ] è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼ŒéªŒè¯ S3Admin æ˜¾ç¤º
- [ ] ç‚¹å‡» "List Objects"ï¼ŒæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
- [ ] é€‰æ‹©æ–‡ä»¶å¹¶ä¸Šä¼ 
- [ ] ä¸‹è½½å·²ä¸Šä¼ çš„æ–‡ä»¶
- [ ] åˆ é™¤æ–‡ä»¶å¹¶ç¡®è®¤

### 3. é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] è¾“å…¥é”™è¯¯å¯†ç  â†’ Edge Function åº”è¿”å› 403
- [ ] æœªç™»å½•ç”¨æˆ·è®¿é—® â†’ S3Admin åº”è¦æ±‚é‡æ–°è®¤è¯
- [ ] å¤§æ–‡ä»¶ä¸Šä¼  â†’ æ£€æŸ¥è¶…æ—¶å’Œå¤§å°é™åˆ¶

---

## ğŸ“ curl å¿«é€Ÿæµ‹è¯•

è·å–å½“å‰ç”¨æˆ·çš„ access_token åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯• Edge Functionï¼š

```bash
# åˆ—å‡ºæ–‡ä»¶
curl -v \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "x-admin-password: YOUR_PASSWORD" \
  "https://zlbemopcgjohrnyyiwvs.functions.supabase.co/s3-compat-storage/list?bucket=wangyiyun&prefix=music/&limit=10"

# ä¸Šä¼ æ–‡ä»¶
curl -v -X PUT \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "x-admin-password: YOUR_PASSWORD" \
  --data-binary @/path/to/file.mp3 \
  "https://zlbemopcgjohrnyyiwvs.functions.supabase.co/s3-compat-storage/put?key=music/file.mp3"
```

---

## ğŸ” è°ƒè¯•èµ„æº

### æŸ¥çœ‹ Edge Function æ—¥å¿—
1. è¿›å…¥ Supabase æ§åˆ¶å°
2. å·¦ä¾§èœå• â†’ Functions
3. ç‚¹å‡» `s3-compat-storage` å‡½æ•°
4. åˆ‡æ¢åˆ° "Logs" æ ‡ç­¾
5. æŸ¥çœ‹æœ€è¿‘çš„è¯·æ±‚æ—¥å¿—

### æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- **Network æ ‡ç­¾**ï¼šæŸ¥çœ‹è¯·æ±‚ headers å’Œå“åº”
- **Console æ ‡ç­¾**ï¼šæŸ¥çœ‹ JavaScript é”™è¯¯
- **Application æ ‡ç­¾**ï¼šéªŒè¯å¯†ç ä¸åœ¨ localStorage ä¸­

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### å‰ç«¯éƒ¨ç½²
1. æ„å»ºé¡¹ç›®ï¼š`npm run build`
2. æ¨é€åˆ° Gitï¼š`git add . && git commit -m "Implement S3Admin with Edge Function"`
3. éƒ¨ç½²åˆ°æœåŠ¡å™¨/CDN

### Edge Function éƒ¨ç½²
1. ç¡®ä¿ `s3-compat-storage` å‡½æ•°å·²éƒ¨ç½²
2. åœ¨ Supabase æ§åˆ¶å°è®¾ç½® `ADMIN_PASSWORD` ç¯å¢ƒå˜é‡
3. æµ‹è¯•å‡½æ•°å¯æ­£å¸¸å“åº”

---

## â“ å¸¸è§é—®é¢˜å¿«é€Ÿå›ç­”

| é—®é¢˜ | å›ç­” |
|------|------|
| å¯†ç ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ | ä»…åœ¨å†…å­˜ä¸­ï¼ˆReact stateï¼‰ï¼Œåˆ·æ–°é¡µé¢åæ¸…é™¤ |
| ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªè®¤è¯ï¼Ÿ | åˆ†å±‚é˜²å¾¡ï¼štoken è¯æ˜ç”¨æˆ·èº«ä»½ï¼Œpassword è¯æ˜ç®¡ç†æƒé™ |
| VITE_FUNCTIONS_URL æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ | `https://PROJECT_REF.functions.supabase.co/s3-compat-storage` |
| å¿˜è®°å¯†ç æ€ä¹ˆåŠï¼Ÿ | ä¿®æ”¹ Edge Function çš„ ADMIN_PASSWORD ç¯å¢ƒå˜é‡ |
| ä¸Šä¼ é™åˆ¶æ˜¯å¤šå°‘ï¼Ÿ | å–å†³äº Supabase è®¡åˆ’å’Œ Edge Function è¶…æ—¶è®¾ç½® |

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [S3ADMIN_INTEGRATION_GUIDE.md](S3ADMIN_INTEGRATION_GUIDE.md) - å®Œæ•´é›†æˆæŒ‡å—
- [components/S3Admin.tsx](components/S3Admin.tsx) - ç»„ä»¶æºä»£ç 
- [pages/AdminPage.tsx](pages/AdminPage.tsx) - ç®¡ç†é¡µé¢æºä»£ç 
- [src/lib/supabaseClient.ts](src/lib/supabaseClient.ts) - Supabase å®¢æˆ·ç«¯æºä»£ç 

---

## âœ¨ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ª**å®Œæ•´ã€å®‰å…¨ã€å¯æ‰©å±•çš„ S3 ç®¡ç†ç•Œé¢**ï¼š

âœ… ç”¨æˆ·è®¤è¯ + ç®¡ç†å‘˜æˆæƒçš„åˆ†å±‚å®‰å…¨æ¶æ„  
âœ… å†…å­˜ä¸­ä¿å­˜å¯†ç ï¼Œæ— æŒä¹…åŒ–é£é™©  
âœ… æ”¯æŒ Listã€Getã€Putã€Delete å››å¤§æ“ä½œ  
âœ… æ¸…æ™°çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ  
âœ… å®Œæ•´çš„æ–‡æ¡£å’Œæµ‹è¯•æŒ‡å—  

**å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ä¸Šçº¿ï¼** ğŸ‰
